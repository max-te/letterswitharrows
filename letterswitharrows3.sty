%% letterswitharrows3.dtx

\RequirePackage{expl3,xparse,ifpdf,mathtools}
\ExplSyntaxOn

%<@@=jmt_letterswitharrows>
\msg_new:nnn {@@} {pdf-only} {Only~pdf~output~is~supported.}
\ifpdf\else
  \msg_warning:nn {@@} {pdf-only}
\fi

\cs_new:Nn \__@@_arrow_draw:nn % length, scale factor
{
    \sys_if_output_pdf:TF {
        \special{pdf:~
          q~
          1~J~1~j~
          1~0~0~#2~0~0~cm~
          .3~w~
          q~
          #2~0~0~1~0~0~cm~
          1~0~0~1~-1~0~cm~
          0~1~m~
          .25~0~1~0~1~0~c~
          1~0~.25~0~0~-1~c~
          S~
          Q~
          0~0~m~
          -1~0~0~1~0~0~cm~
          \dim_to_decimal:n{#1}~0~l~S~
          Q
        }
    } {
    % \msg_warning:nn{@@}{pdf-only}
    }
}
\cs_new:Nn \__@@_arrow_right:nn
{
    \hspace{#1}
    % \rule[\dimexpr -#2pt/6\relax]{#1}{\dimexpr #2pt/3\relax}
    \__@@_arrow_draw:nn {#1} {#2}
}
\cs_new:Nn \__@@_arrow_left:nn
{
    \__@@_arrow_draw:nn {\dim_eval:n{-#1}} {-#2}
    \hspace{#1}
    % \rule[\dimexpr -#2pt/6\relax]{#1}{\dimexpr #2pt/3\relax}
}

\cs_new:Nn \__@@_arrow_overset_style:Nnnnnnn
{
    \hbox_set:Nn \l_tmpa_box {$\m@th#1#3$}
    % \dim_set:Nn \l_tmpa_dim {#2pt*\f@size/10} % Why doesn't this work?
    \dim_set:Nn \l_tmpa_dim {\fp_to_dim:n {#2pt*\f@size/10}}
    \vbox {
        \lineskiplimit=\maxdimen
        \baselineskip=0pt
        \lineskip=\dim_eval:n {\l_tmpa_dim * 3/2 + #6}
        \halign { ## \cr
            \hspace{\dim_eval:n{\l_tmpa_dim / 2}}
            \m@th$#1
            \mskip\muskip_eval:n {#5}
            \use:c{#4}{\dim_eval:n{\box_wd:N \l_tmpa_box * #7}}{\dim_to_decimal:n {\l_tmpa_dim}}
            $
            \cr
            \box_use_drop:N \l_tmpa_box
            \cr
        }
    }
}
\cs_new:Nn \__@@_arrow_overset:nnnnn % content, direction, xoffset, yoffset, scale
{
    \mathchoice
        {\__@@_arrow_overset_style:Nnnnnnn \displaystyle 1 {#1} {__@@_arrow_#2:nn} {#3} {#4} {#5}}
        {\__@@_arrow_overset_style:Nnnnnnn \textstyle 1 {#1} {__@@_arrow_#2:nn} {#3} {#4} {#5}}
        {\__@@_arrow_overset_style:Nnnnnnn \scriptstyle {.8} {#1} {__@@_arrow_#2:nn} {#3} {#4} {#5}}
        {\__@@_arrow_overset_style:Nnnnnnn \scriptscriptstyle {.6} {#1} {__@@_arrow_#2:nn} {#3} {#4} {#5}}
}

\cs_new:Nn \__@@_arrow_overset:nn
{
    \__@@_arrow_overset:nnnnn {#1} {#2} {0mu} {0ex} {1}
}

\cs_new_protected:Npn \@@_arrow_overset:w {
  \c_group_begin_token
  \__@@_arrow_overset:w
}
\exp_args:NNx \NewDocumentCommand \__@@_arrow_overset:w {s m O{0mu} O{0ex} O{1} t' e{\char_generate:nn {95}{8}} t'} {
  \__@@_arrow_overset:nnnnn 
    {
      #2^{\scriptscriptstyle\IfBooleanT{#6}{\prime}\IfBooleanT{#8}{\prime}} % TODO: Better positioning?
      \exp_args:Nf\IfValueT{\use:n#7} {
        \c_math_subscript_token
        {
          \mathrlap{#7}
        }
      }
    }
    {\IfBooleanTF{#1}{left}{right}} {#3} {#4} {#5}

    \exp_args:Nf\IfValueTF{\use:n#7}{ % TODO: Better way to do this? This is all kinds of wrong.
      \hphantom{#7}
    }{
      %\mkern2.5mu
    }
    \c_group_end_token
}


\int_step_inline:nnn {1} {26}
{
    \int_compare:nNnTF {#1} = {22}
    {
        \cs_new:cpx {\int_to_alph:n{#1}right} {
          \exp_not:N\@@_arrow_overset:w{\int_to_alph:n{#1}}
        }
        \cs_new:cpx {\int_to_alph:n{#1}left} {
            \exp_not:N\@@_arrow_overset:w*{\int_to_alph:n{#1}}
        }
    }
    {
        \cs_new:cpx {v\int_to_alph:n{#1}} {
            \exp_not:N\@@_arrow_overset:w{\int_to_alph:n{#1}}
        }
        \cs_new:cpx {\int_to_alph:n{#1}v} {
            \exp_not:N\@@_arrow_overset:w*{\int_to_alph:n{#1}}
        }
    }
    \cs_new:cpx {v\int_to_Alph:n{#1}} {
        \exp_not:N\@@_arrow_overset:w{\int_to_Alph:n{#1}}
    }
    \cs_new:cpx {\int_to_Alph:n{#1}v} {
        \exp_not:N\@@_arrow_overset:w*{\int_to_Alph:n{#1}}
    }
    \cs_new:cpx {vc\int_to_Alph:n{#1}} {
      \exp_not:N\@@_arrow_overset:w{\exp_not:N\mathcal{\int_to_Alph:n{#1}}}
    }
    \cs_new:cpx {c\int_to_Alph:n{#1}v} {
        \exp_not:N\@@_arrow_overset:w*{\exp_not:N\mathcal{\int_to_Alph:n{#1}}}
    }
}

%% ADJUSTMENTS
\cs_set:cpn {vS} {
  \@@_arrow_overset:w{S}[3mu][0ex][8/10]
}
